"use strict";var Pe=Object.create;var z=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var we=Object.getOwnPropertyNames;var xe=Object.getPrototypeOf,_e=Object.prototype.hasOwnProperty;var be=(e,d)=>{for(var r in d)z(e,r,{get:d[r],enumerable:!0})},ne=(e,d,r,o)=>{if(d&&typeof d=="object"||typeof d=="function")for(let t of we(d))!_e.call(e,t)&&t!==r&&z(e,t,{get:()=>d[t],enumerable:!(o=Ee(d,t))||o.enumerable});return e};var I=(e,d,r)=>(r=e!=null?Pe(xe(e)):{},ne(d||!e||!e.__esModule?z(r,"default",{value:e,enumerable:!0}):r,e)),ve=e=>ne(z({},"__esModule",{value:!0}),e);var Se={};be(Se,{CldImage:()=>Q,CldOgImage:()=>ee,CldUploadButton:()=>te,CldUploadWidget:()=>H,CldVideoPlayer:()=>oe,cloudinaryLoader:()=>Y,getCldImageUrl:()=>O,getCldOgImageUrl:()=>Ue});module.exports=ve(Se);var v=I(require("react")),pe=I(require("next/image")),ge=require("@cloudinary-util/util"),me=require("@cloudinary-util/url-loader");async function F(e){let{src:d}=e;try{await new Promise((r,o)=>{fetch(d).then(t=>{if(!t.ok){o(t);return}r(t)})})}catch(r){return r.status===423?await F(e):!1}return!0}var ce=require("@cloudinary-util/url-loader");var ae=I(require("next/package.json"));var ie={name:"next-cloudinary",version:"4.22.0",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup src/index.ts --dts",dev:"tsup src/index.ts --watch --dts",prepublishOnly:"cp ../README.md . && yarn build",postpublish:"rm ./README.md",test:"jest","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" yarn build && cd tests/nextjs-app && yarn build'},dependencies:{"@cloudinary-util/url-loader":"^3.10.0","@cloudinary-util/util":"^2.2.1"},devDependencies:{"@babel/core":"^7.19.6","@babel/preset-env":"^7.19.4","@types/jest":"^29.2.0","@types/react":"^18.0.28","@types/react-dom":"^18.0.11","babel-jest":"^29.2.2",dotenv:"^16.0.3",jest:"^29.2.2","jest-environment-jsdom":"^29.2.2",mkdirp:"^3.0.1","ts-jest":"^29.0.3",tsup:"^7.2.0",typescript:"^5.2.2"},peerDependencies:{next:"^12 || ^13",react:"^17 || ^18"}};var de="V",le=ie.version,se=ae.default.version;function O(e,d,r){return(0,ce.constructCloudinaryUrl)({options:e,config:Object.assign({cloud:{cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME}},d),analytics:Object.assign({sdkCode:de,sdkSemver:le,techVersion:se,feature:""},r)})}function Y({loaderOptions:e,imageProps:d,cldOptions:r,cldConfig:o={}}){let t={...d,...r};if(t.width=typeof t.width=="string"?parseInt(t.width):t.width,t.height=typeof t.height=="string"?parseInt(t.height):t.height,typeof(e==null?void 0:e.width)=="number"&&typeof t.width=="number"&&e.width!==t.width){let l=e.width/t.width;t.widthResize=e.width,typeof t.height=="number"&&(t.heightResize=Math.round(t.height*l))}return O(t,o)}var fe=(0,v.forwardRef)((e,d)=>{let r=["deliveryType","preserveTransformations"];me.transformationPlugins.forEach(({props:n=[]})=>{n.forEach(p=>{if(r.includes(p))throw new Error(`Option ${p} already exists!`);r.push(p)})});let o={alt:e.alt,src:e.src};Object.keys(e).filter(n=>!r.includes(n)).forEach(n=>o[n]=e[n]);let t=Object.keys(o).map(n=>`${n}:${o[n]}`).join(";"),[l,g]=(0,v.useState)(t),c={};if(r.forEach(n=>{e[n]&&(c[n]=e[n]||void 0)}),e.preserveTransformations)try{let n=(0,ge.getTransformations)(e.src).map(p=>p.join(","));c.rawTransformations=[...n.flat(),...e.rawTransformations||[]]}catch(n){console.warn(`Failed to preserve transformations: ${n.message}`)}let m=process.env.__NEXT_IMAGE_OPTS||{};(e.unoptimized===!0||(m==null?void 0:m.unoptimized)===!0)&&(o.src=O({...c,width:o.width,height:o.height,src:o.src,format:"default",quality:"default"},e.config));async function s(n){let p=!0;if(typeof e.onError=="function"){let w=e.onError(n);typeof w=="boolean"&&w===!1&&(p=!1)}else typeof e.onError=="boolean"&&e.onError===!1&&(p=!1);if(p===!1)return;let y=n.target;await F({src:y.src})&&g(`${t};${Date.now()}`)}let a=(0,v.useCallback)(s,[F,t]),U=pe.default;return"default"in U&&(U=U.default),v.default.createElement(U,{key:l,...o,loader:n=>Y({loaderOptions:n,imageProps:o,cldOptions:c,cldConfig:e.config}),onError:a,ref:d})});fe.displayName="CldImage";var Q=fe;var E=I(require("react")),ue=I(require("next/head"));var Te="summary_large_image",Ae=({excludeTags:e=[],twitterTitle:d,keys:r={},...o})=>{let{alt:t}=o,l={...o,crop:o.crop||"fill",gravity:o.gravity||"center",height:o.height||1254,src:o.src,width:o.width||2400,widthResize:o.width||1200},g=typeof l.width=="string"?parseInt(l.width):l.width,c=typeof l.height=="string"?parseInt(l.height):l.height;typeof c=="number"&&typeof g=="number"&&(c=1200/g*c),g=1200;let m=O({...l,format:o.format||"jpg"}),s=O({...l,format:o.format||"webp"}),a={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...r};return E.default.createElement(ue.default,null,E.default.createElement("meta",{key:a["og:image"],property:"og:image",content:m}),E.default.createElement("meta",{key:a["og:image:secure_url"],property:"og:image:secure_url",content:m}),E.default.createElement("meta",{key:a["og:image:width"],property:"og:image:width",content:`${g}`}),E.default.createElement("meta",{key:a["og:image:height"],property:"og:image:height",content:`${c}`}),t&&E.default.createElement("meta",{key:a["og:image:alt"],property:"og:image:alt",content:t}),!e.includes("twitter:title")&&E.default.createElement("meta",{key:a["twitter:title"],property:"twitter:title",content:d||" "}),E.default.createElement("meta",{key:a["twitter:card"],property:"twitter:card",content:Te}),E.default.createElement("meta",{key:a["twitter:image"],property:"twitter:image",content:s}))},ee=Ae;var $=I(require("react"));var u=I(require("react")),Ce=I(require("next/script"));function ye(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var Ne=["success","display-changed"],We={abort:"onAbort","batch-cancelled":"onBatchCancelled","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},Ge=({children:e,onClose:d,onError:r,onOpen:o,onUpload:t,options:l,signatureEndpoint:g,uploadPreset:c,...m})=>{let s=(0,u.useRef)(),a=(0,u.useRef)(),U=!!g,[n,p]=(0,u.useState)(void 0),[y,T]=(0,u.useState)(void 0),[w,M]=(0,u.useState)(!0),x={cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,uploadPreset:c||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,...l};U&&(x.uploadSignature=A,x.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),(0,u.useEffect)(()=>{if(typeof y=="undefined")return;let C=y.event==="success",b=y.event==="display-changed"&&y.info==="hidden";C&&typeof t=="function"&&t(y,a.current),b&&typeof d=="function"&&d(a.current)},[y]),(0,u.useEffect)(()=>{n&&typeof r=="function"&&r(n,a.current)},[n]);function L(){M(!1),s.current||(s.current=window.cloudinary),ye(()=>{a.current||(a.current=B())})}function A(C,b){if(typeof g=="undefined")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(g,{method:"POST",body:JSON.stringify({paramsToSign:b})}).then(i=>i.json()).then(({signature:i})=>{C(i)})}function f(C){a.current||(a.current=B()),typeof(a==null?void 0:a.current[C])=="function"&&a.current[C]()}function S(){f("close")}function N(){f("destroy")}function _(){f("hide")}function W(){f("isDestroyed")}function G(){f("isMinimized")}function k(){f("isShowing")}function q(){f("minimize")}function V(){f("open"),typeof o=="function"&&o(a.current)}function K(){f("show")}function j(){f("update")}let D={close:S,destroy:N,hide:_,isDestroyed:W,isMinimized:G,isShowing:k,minimize:q,open:V,show:K,update:j};function B(){var C;return(C=s.current)==null?void 0:C.createUploadWidget(x,(b,i)=>{if(typeof b=="string"&&p(b),typeof(i==null?void 0:i.event)=="string"){Ne.includes(i==null?void 0:i.event)&&T(i);let P=We[i.event];if(typeof P=="string"&&typeof m[P]=="function"&&typeof m[P]){let X=m[P];X(i,{widget:a.current,...D})}}})}return u.default.createElement(u.default.Fragment,null,typeof e=="function"&&e({cloudinary:s.current,widget:a.current,results:y,error:n,isLoading:w,...D}),u.default.createElement(Ce.default,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://widget.cloudinary.com/v2.0/global/all.js",onLoad:L,onError:C=>console.error(`Failed to load Cloudinary Upload Widget: ${C.message}`)}))},H=Ge;var De=({className:e,children:d,onClick:r,onError:o,onOpen:t,onUpload:l,onAbort:g,onBatchCancelled:c,onClose:m,onDisplayChanged:s,onPublicId:a,onQueuesEnd:U,onQueuesStart:n,onRetry:p,onShowCompleted:y,onSourceChanged:T,onSuccess:w,onTags:M,onUploadAdded:x,options:L,signatureEndpoint:A,uploadPreset:f,...S})=>$.default.createElement($.default.Fragment,null,$.default.createElement(H,{onError:o,onOpen:t,onUpload:l,onAbort:g,onBatchCancelled:c,onClose:m,onDisplayChanged:s,onPublicId:a,onQueuesEnd:U,onQueuesStart:n,onRetry:p,onShowCompleted:y,onSourceChanged:T,onSuccess:w,onTags:M,onUploadAdded:x,options:L,signatureEndpoint:A,uploadPreset:f},({open:N,isLoading:_})=>{function W(G){G.preventDefault(),N(),typeof r=="function"&&r(G)}return $.default.createElement("button",{...S,className:e||"",onClick:W,disabled:_},d||"Upload")})),te=De;var h=I(require("react")),he=I(require("next/script")),Ie=I(require("next/head")),Oe=require("@cloudinary-util/util"),Me=e=>{let d=(0,h.useRef)(Math.ceil(Math.random()*1e5)),{autoPlay:r="never",className:o,colors:t,controls:l=!0,fontFace:g,height:c,id:m,logo:s=!0,loop:a=!1,muted:U=!1,onDataLoad:n,onError:p,onMetadataLoad:y,onPause:T,onPlay:w,onEnded:M,src:x,transformation:L,version:A="1.9.16",quality:f="auto",width:S}=e,N=Array.isArray(L)?L:[L],_=x;if(typeof e.version=="string"&&console.warn("The version prop will no longer be supported in future versions due to the unreliability of coordinating assets"),_.startsWith("http"))try{let i=(0,Oe.parseUrl)(x);typeof(i==null?void 0:i.publicId)=="string"&&(_=i==null?void 0:i.publicId)}catch(i){}N.unshift({quality:f});let W=(0,h.useRef)(),G=(0,h.useRef)(),k=e.videoRef||G,q=(0,h.useRef)(),V=e.playerRef||q,K=m||`player-${_.replace("/","-")}-${d.current}`,j="cld-video-player cld-fluid";o&&(j=`${j} ${o}`);let D={error:p,loadeddata:n,loadedmetadata:y,pause:T,play:w,ended:M};function B(i){let P=D[i.type];typeof P=="function"&&P(b())}function C(){if("cloudinary"in window){W.current=window.cloudinary;let i={};typeof s=="boolean"?i.showLogo=s:typeof s=="object"&&(i={...i,showLogo:!0,logoImageUrl:s.imageUrl,logoOnclickUrl:s.onClickUrl});let P={autoplayMode:r,cloud_name:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,controls:l,fontFace:g||"",loop:a,muted:U,publicId:_,secure:!0,transformation:N,...i};typeof t=="object"&&(P.colors=t),V.current=W.current.videoPlayer(k.current,P),Object.keys(D).forEach(X=>{var re;typeof D[X]=="function"&&((re=V.current)==null||re.on(X,B))})}}function b(){return{player:V.current,video:k.current}}return h.default.createElement(h.default.Fragment,null,h.default.createElement(Ie.default,null,h.default.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${A}/dist/cld-video-player.min.css`,rel:"stylesheet"})),h.default.createElement("div",{style:{width:"100%",aspectRatio:`${e.width} / ${e.height}`}},h.default.createElement("video",{ref:k,id:K,className:j,width:S,height:c}),h.default.createElement(he.default,{id:`cloudinary-videoplayer-${Math.floor(Math.random()*100)}`,src:`https://unpkg.com/cloudinary-video-player@${A}/dist/cld-video-player.min.js`,onLoad:C,onError:i=>console.error(`Failed to load Cloudinary Video Player: ${i.message}`)})))},oe=Me;function Ue(e){return O({...e,crop:e.crop||"fill",format:e.format||"jpg",gravity:e.gravity||"center",height:e.height||1254,width:e.width||2400,widthResize:e.width||1200})}0&&(module.exports={CldImage,CldOgImage,CldUploadButton,CldUploadWidget,CldVideoPlayer,cloudinaryLoader,getCldImageUrl,getCldOgImageUrl});
//# sourceMappingURL=index.js.map