import ye,{useState as Ce,useCallback as he,forwardRef as Ie}from"react";import Ue from"next/image";import{getTransformations as Oe}from"@cloudinary-util/util";import{transformationPlugins as we}from"@cloudinary-util/url-loader";async function R(e){let{src:s}=e;try{await new Promise((d,o)=>{fetch(s).then(t=>{if(!t.ok){o(t);return}d(t)})})}catch(d){return d.status===423?await R(e):!1}return!0}import{constructCloudinaryUrl as fe}from"@cloudinary-util/url-loader";import me from"next/package.json";var ee={name:"next-cloudinary",version:"4.27.0",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup src/index.ts --dts",dev:"tsup src/index.ts --watch --dts",prepublishOnly:"cp ../README.md . && yarn build",postpublish:"rm ./README.md",test:"jest","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" yarn build && cd tests/nextjs-app && yarn build'},dependencies:{"@cloudinary-util/url-loader":"^3.11.0","@cloudinary-util/util":"^2.2.1"},devDependencies:{"@babel/core":"^7.19.6","@babel/preset-env":"^7.19.4","@types/jest":"^29.2.0","@types/react":"^18.0.28","@types/react-dom":"^18.0.11","babel-jest":"^29.2.2",dotenv:"^16.0.3",jest:"^29.2.2","jest-environment-jsdom":"^29.2.2",mkdirp:"^3.0.1","ts-jest":"^29.0.3",tsup:"^7.2.0",typescript:"^5.2.2"},peerDependencies:{next:"^12 || ^13",react:"^17 || ^18"}};var te="V",oe=ee.version,re=me.version;function I(e,s,d){var t,i;let o=(i=(t=s==null?void 0:s.cloud)==null?void 0:t.cloudName)!=null?i:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;return fe({options:e,config:Object.assign({cloud:{cloudName:o}},s),analytics:Object.assign({sdkCode:te,sdkSemver:oe,techVersion:re,feature:""},d)})}function z({loaderOptions:e,imageProps:s,cldOptions:d,cldConfig:o={}}){let t={...s,...d};if(t.width=typeof t.width=="string"?parseInt(t.width):t.width,t.height=typeof t.height=="string"?parseInt(t.height):t.height,typeof(e==null?void 0:e.width)=="number"&&typeof t.width=="number"&&e.width!==t.width){let i=e.width/t.width;t.widthResize=e.width,typeof t.height=="number"&&(t.heightResize=Math.round(t.height*i))}else typeof(e==null?void 0:e.width)=="number"&&typeof(t==null?void 0:t.width)!="number"&&(t.width=e.width,t.widthResize=e.width);return I(t,o)}var ne=Ie((e,s)=>{let d=!1,o=["deliveryType","preserveTransformations"];we.forEach(({props:n=[]})=>{n.forEach(l=>{if(o.includes(l))throw new Error(`Option ${l} already exists!`);o.push(l)})});let t={alt:e.alt,src:e.src};Object.keys(e).filter(n=>!o.includes(n)).forEach(n=>t[n]=e[n]);let i=Object.keys(t).map(n=>`${n}:${t[n]}`).join(";"),[u,C]=Ce(i),c={};if(o.forEach(n=>{e[n]&&(c[n]=e[n]||void 0)}),e.preserveTransformations)try{let n=Oe(e.src).map(l=>l.join(","));c.rawTransformations=[...n.flat(),...e.rawTransformations||[]]}catch(n){console.warn(`Failed to preserve transformations: ${n.message}`)}let m=process.env.__NEXT_IMAGE_OPTS||{};(e.unoptimized===!0||(m==null?void 0:m.unoptimized)===!0)&&(t.src=I({...c,width:t.width,height:t.height,src:t.src,format:"default",quality:"default"},e.config));async function r(n){let l=!0;if(d)return;if(d=!0,typeof e.onError=="function"){let U=e.onError(n);typeof U=="boolean"&&U===!1&&(l=!1)}else typeof e.onError=="boolean"&&e.onError===!1&&(l=!1);if(l===!1)return;let _=n.target;await R({src:_.src})&&C(`${i};${Date.now()}`)}let x=he(r,[R,i]),y=Ue;return"default"in y&&(y=y.default),ye.createElement(y,{key:u,...t,loader:n=>z({loaderOptions:n,imageProps:t,cldOptions:c,cldConfig:e.config}),onError:x,ref:s})});ne.displayName="CldImage";var ie=ne;import O from"react";import Pe from"next/head";var Ee="summary_large_image",xe=({excludeTags:e=[],twitterTitle:s,keys:d={},...o})=>{let{alt:t}=o,i={...o,crop:o.crop||"fill",gravity:o.gravity||"center",height:o.height||1254,src:o.src,width:o.width||2400,widthResize:o.width||1200},u=typeof i.width=="string"?parseInt(i.width):i.width,C=typeof i.height=="string"?parseInt(i.height):i.height;typeof C=="number"&&typeof u=="number"&&(C=1200/u*C),u=1200;let c=I({...i,format:o.format||"jpg"}),m=I({...i,format:o.format||"webp"}),r={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...d};return O.createElement(Pe,null,O.createElement("meta",{key:r["og:image"],property:"og:image",content:c}),O.createElement("meta",{key:r["og:image:secure_url"],property:"og:image:secure_url",content:c}),O.createElement("meta",{key:r["og:image:width"],property:"og:image:width",content:`${u}`}),O.createElement("meta",{key:r["og:image:height"],property:"og:image:height",content:`${C}`}),t&&O.createElement("meta",{key:r["og:image:alt"],property:"og:image:alt",content:t}),!e.includes("twitter:title")&&O.createElement("meta",{key:r["twitter:title"],property:"twitter:title",content:s||" "}),O.createElement("meta",{key:r["twitter:card"],property:"twitter:card",content:Ee}),O.createElement("meta",{key:r["twitter:image"],property:"twitter:image",content:m}))},ae=xe;import $ from"react";import q,{useState as K,useEffect as le,useRef as se}from"react";import _e from"next/script";function de(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var be=["success","display-changed"],ve={abort:"onAbort","batch-cancelled":"onBatchCancelled","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},Te=({children:e,onClose:s,onError:d,onOpen:o,onUpload:t,options:i,signatureEndpoint:u,uploadPreset:C,...c})=>{let m=se(),r=se(),x=!!u,[y,n]=K(void 0),[l,_]=K(void 0),[T,U]=K(!0),w={cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,uploadPreset:C||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,...i};x&&(w.uploadSignature=L,w.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),le(()=>{if(typeof l=="undefined")return;let p=l.event==="success",h=l.event==="display-changed"&&l.info==="hidden";p&&typeof t=="function"&&t(l,r.current),h&&typeof s=="function"&&s(r.current)},[l]),le(()=>{y&&typeof d=="function"&&d(y,r.current)},[y]);function b(){U(!1),m.current||(m.current=window.cloudinary),de(()=>{r.current||(r.current=D())})}function L(p,h){if(typeof u=="undefined")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(u,{method:"POST",body:JSON.stringify({paramsToSign:h})}).then(g=>g.json()).then(({signature:g})=>{p(g)})}function f(p,h=[]){if(r.current||(r.current=D()),typeof(r==null?void 0:r.current[p])=="function")return r.current[p](...h)}function S(p){f("close",[p])}function W(p){return f("destroy",[p])}function P(){f("hide")}function M(){return f("isDestroyed")}function A(){return f("isMinimized")}function G(){return f("isShowing")}function B(){f("minimize")}function k(p,h){f("open",[p,h]),typeof o=="function"&&o(r.current)}function N(){f("show")}function V(){f("update")}let F={close:S,destroy:W,hide:P,isDestroyed:M,isMinimized:A,isShowing:G,minimize:B,open:k,show:N,update:V};function D(){var p;return(p=m.current)==null?void 0:p.createUploadWidget(w,(h,g)=>{if(typeof h=="string"&&n(h),typeof(g==null?void 0:g.event)=="string"){be.includes(g==null?void 0:g.event)&&_(g);let a=ve[g.event];if(typeof a=="string"&&typeof c[a]=="function"&&typeof c[a]){let E=c[a];E(g,{widget:r.current,...F})}}})}return q.createElement(q.Fragment,null,typeof e=="function"&&e({cloudinary:m.current,widget:r.current,results:l,error:y,isLoading:T,...F}),q.createElement(_e,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://widget.cloudinary.com/v2.0/global/all.js",onLoad:b,onError:p=>console.error(`Failed to load Cloudinary Upload Widget: ${p.message}`)}))},H=Te;var Le=({className:e,children:s,onClick:d,onError:o,onOpen:t,onUpload:i,onAbort:u,onBatchCancelled:C,onClose:c,onDisplayChanged:m,onPublicId:r,onQueuesEnd:x,onQueuesStart:y,onRetry:n,onShowCompleted:l,onSourceChanged:_,onSuccess:T,onTags:U,onUploadAdded:w,options:b,signatureEndpoint:L,uploadPreset:f,...S})=>$.createElement($.Fragment,null,$.createElement(H,{onError:o,onOpen:t,onUpload:i,onAbort:u,onBatchCancelled:C,onClose:c,onDisplayChanged:m,onPublicId:r,onQueuesEnd:x,onQueuesStart:y,onRetry:n,onShowCompleted:l,onSourceChanged:_,onSuccess:T,onTags:U,onUploadAdded:w,options:b,signatureEndpoint:L,uploadPreset:f},({open:W,isLoading:P})=>{function M(A){A.preventDefault(),W(),typeof d=="function"&&d(A)}return $.createElement("button",{...S,className:e||"",onClick:M,disabled:P},s||"Upload")})),ce=Le;import v,{useRef as Q}from"react";import We from"next/script";import Me from"next/head";import{parseUrl as Ae}from"@cloudinary-util/util";var pe=[],Ne=e=>{let{autoPlay:s="never",className:d,colors:o,controls:t=!0,fontFace:i,height:u,id:C,logo:c=!0,loop:m=!1,muted:r=!1,onDataLoad:x,onError:y,onMetadataLoad:n,onPause:l,onPlay:_,onEnded:T,src:U,sourceTypes:w,transformation:b,version:L="1.9.16",quality:f="auto",width:S}=e,W=Array.isArray(b)?b:[b],P=U||"";if(typeof e.version=="string"&&console.warn("The version prop will no longer be supported in future versions due to the unreliability of coordinating assets"),P.startsWith("http"))try{let a=Ae(U);typeof(a==null?void 0:a.publicId)=="string"&&(P=a==null?void 0:a.publicId)}catch(a){}W.unshift({quality:f});let M=Q(),A=Q(),G=e.videoRef||A,B=Q(),k=e.playerRef||B,N=C||`player-${P.replace("/","-")}`,V="cld-video-player cld-fluid";d&&(V=`${V} ${d}`),pe.filter(a=>a===N).length>1?console.warn(`Multiple instances of the same video detected on the
     page which may cause some features to not work. 
    Try adding a unique id to each player.`):pe.push(N);let D={error:y,loadeddata:x,loadedmetadata:n,pause:l,play:_,ended:T};function p(a){let E=D[a.type];typeof E=="function"&&E(g())}function h(){if("cloudinary"in window){M.current=window.cloudinary;let a={};typeof c=="boolean"?a.showLogo=c:typeof c=="object"&&(a={...a,showLogo:!0,logoImageUrl:c.imageUrl,logoOnclickUrl:c.onClickUrl});let E={autoplayMode:s,cloud_name:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,controls:t,fontFace:i||"",loop:m,muted:r,publicId:P,secure:!0,transformation:W,...a};Array.isArray(w)&&(E.sourceTypes=w),typeof o=="object"&&(E.colors=o),k.current=M.current.videoPlayer(G.current,E),Object.keys(D).forEach(J=>{var Z;typeof D[J]=="function"&&((Z=k.current)==null||Z.on(J,p))})}}function g(){return{player:k.current,video:G.current}}return v.createElement(v.Fragment,null,v.createElement(Me,null,v.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${L}/dist/cld-video-player.min.css`,rel:"stylesheet"})),v.createElement("div",{style:{width:"100%",aspectRatio:`${e.width} / ${e.height}`}},v.createElement("video",{ref:G,id:N,className:V,width:S,height:u}),v.createElement(We,{id:`cloudinary-videoplayer-${N}`,src:`https://unpkg.com/cloudinary-video-player@${L}/dist/cld-video-player.min.js`,onLoad:h,onError:a=>console.error(`Failed to load Cloudinary Video Player: ${a.message}`)})))},ge=Ne;function De(e){return I({...e,crop:e.crop||"fill",format:e.format||"jpg",gravity:e.gravity||"center",height:e.height||1254,width:e.width||2400,widthResize:e.width||1200})}export{ie as CldImage,ae as CldOgImage,ce as CldUploadButton,H as CldUploadWidget,ge as CldVideoPlayer,z as cloudinaryLoader,I as getCldImageUrl,De as getCldOgImageUrl};
//# sourceMappingURL=index.mjs.map