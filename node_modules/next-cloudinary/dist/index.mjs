import fe,{useState as ue,useCallback as ye,forwardRef as Ce}from"react";import he from"next/image";import{getTransformations as Ie}from"@cloudinary-util/util";import{transformationPlugins as Oe}from"@cloudinary-util/url-loader";async function R(e){let{src:l}=e;try{await new Promise((a,o)=>{fetch(l).then(t=>{if(!t.ok){o(t);return}a(t)})})}catch(a){return a.status===423?await R(e):!1}return!0}import{constructCloudinaryUrl as me}from"@cloudinary-util/url-loader";import ge from"next/package.json";var Z={name:"next-cloudinary",version:"4.22.0",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup src/index.ts --dts",dev:"tsup src/index.ts --watch --dts",prepublishOnly:"cp ../README.md . && yarn build",postpublish:"rm ./README.md",test:"jest","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" yarn build && cd tests/nextjs-app && yarn build'},dependencies:{"@cloudinary-util/url-loader":"^3.10.0","@cloudinary-util/util":"^2.2.1"},devDependencies:{"@babel/core":"^7.19.6","@babel/preset-env":"^7.19.4","@types/jest":"^29.2.0","@types/react":"^18.0.28","@types/react-dom":"^18.0.11","babel-jest":"^29.2.2",dotenv:"^16.0.3",jest:"^29.2.2","jest-environment-jsdom":"^29.2.2",mkdirp:"^3.0.1","ts-jest":"^29.0.3",tsup:"^7.2.0",typescript:"^5.2.2"},peerDependencies:{next:"^12 || ^13",react:"^17 || ^18"}};var ee="V",te=Z.version,oe=ge.version;function I(e,l,a){return me({options:e,config:Object.assign({cloud:{cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME}},l),analytics:Object.assign({sdkCode:ee,sdkSemver:te,techVersion:oe,feature:""},a)})}function F({loaderOptions:e,imageProps:l,cldOptions:a,cldConfig:o={}}){let t={...l,...a};if(t.width=typeof t.width=="string"?parseInt(t.width):t.width,t.height=typeof t.height=="string"?parseInt(t.height):t.height,typeof(e==null?void 0:e.width)=="number"&&typeof t.width=="number"&&e.width!==t.width){let d=e.width/t.width;t.widthResize=e.width,typeof t.height=="number"&&(t.heightResize=Math.round(t.height*d))}return I(t,o)}var re=Ce((e,l)=>{let a=["deliveryType","preserveTransformations"];Oe.forEach(({props:r=[]})=>{r.forEach(p=>{if(a.includes(p))throw new Error(`Option ${p} already exists!`);a.push(p)})});let o={alt:e.alt,src:e.src};Object.keys(e).filter(r=>!a.includes(r)).forEach(r=>o[r]=e[r]);let t=Object.keys(o).map(r=>`${r}:${o[r]}`).join(";"),[d,g]=ue(t),c={};if(a.forEach(r=>{e[r]&&(c[r]=e[r]||void 0)}),e.preserveTransformations)try{let r=Ie(e.src).map(p=>p.join(","));c.rawTransformations=[...r.flat(),...e.rawTransformations||[]]}catch(r){console.warn(`Failed to preserve transformations: ${r.message}`)}let m=process.env.__NEXT_IMAGE_OPTS||{};(e.unoptimized===!0||(m==null?void 0:m.unoptimized)===!0)&&(o.src=I({...c,width:o.width,height:o.height,src:o.src,format:"default",quality:"default"},e.config));async function s(r){let p=!0;if(typeof e.onError=="function"){let U=e.onError(r);typeof U=="boolean"&&U===!1&&(p=!1)}else typeof e.onError=="boolean"&&e.onError===!1&&(p=!1);if(p===!1)return;let u=r.target;await R({src:u.src})&&g(`${t};${Date.now()}`)}let i=ye(s,[R,t]),C=he;return"default"in C&&(C=C.default),fe.createElement(C,{key:d,...o,loader:r=>F({loaderOptions:r,imageProps:o,cldOptions:c,cldConfig:e.config}),onError:i,ref:l})});re.displayName="CldImage";var ne=re;import O from"react";import Ue from"next/head";var Pe="summary_large_image",Ee=({excludeTags:e=[],twitterTitle:l,keys:a={},...o})=>{let{alt:t}=o,d={...o,crop:o.crop||"fill",gravity:o.gravity||"center",height:o.height||1254,src:o.src,width:o.width||2400,widthResize:o.width||1200},g=typeof d.width=="string"?parseInt(d.width):d.width,c=typeof d.height=="string"?parseInt(d.height):d.height;typeof c=="number"&&typeof g=="number"&&(c=1200/g*c),g=1200;let m=I({...d,format:o.format||"jpg"}),s=I({...d,format:o.format||"webp"}),i={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...a};return O.createElement(Ue,null,O.createElement("meta",{key:i["og:image"],property:"og:image",content:m}),O.createElement("meta",{key:i["og:image:secure_url"],property:"og:image:secure_url",content:m}),O.createElement("meta",{key:i["og:image:width"],property:"og:image:width",content:`${g}`}),O.createElement("meta",{key:i["og:image:height"],property:"og:image:height",content:`${c}`}),t&&O.createElement("meta",{key:i["og:image:alt"],property:"og:image:alt",content:t}),!e.includes("twitter:title")&&O.createElement("meta",{key:i["twitter:title"],property:"twitter:title",content:l||" "}),O.createElement("meta",{key:i["twitter:card"],property:"twitter:card",content:Pe}),O.createElement("meta",{key:i["twitter:image"],property:"twitter:image",content:s}))},ie=Ee;import $ from"react";import K,{useState as Q,useEffect as de,useRef as le}from"react";import we from"next/script";function ae(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var xe=["success","display-changed"],_e={abort:"onAbort","batch-cancelled":"onBatchCancelled","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},be=({children:e,onClose:l,onError:a,onOpen:o,onUpload:t,options:d,signatureEndpoint:g,uploadPreset:c,...m})=>{let s=le(),i=le(),C=!!g,[r,p]=Q(void 0),[u,b]=Q(void 0),[U,W]=Q(!0),P={cloudName:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,uploadPreset:c||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,...d};C&&(P.uploadSignature=v,P.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),de(()=>{if(typeof u=="undefined")return;let y=u.event==="success",w=u.event==="display-changed"&&u.info==="hidden";y&&typeof t=="function"&&t(u,i.current),w&&typeof l=="function"&&l(i.current)},[u]),de(()=>{r&&typeof a=="function"&&a(r,i.current)},[r]);function x(){W(!1),s.current||(s.current=window.cloudinary),ae(()=>{i.current||(i.current=V())})}function v(y,w){if(typeof g=="undefined")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(g,{method:"POST",body:JSON.stringify({paramsToSign:w})}).then(n=>n.json()).then(({signature:n})=>{y(n)})}function f(y){i.current||(i.current=V()),typeof(i==null?void 0:i.current[y])=="function"&&i.current[y]()}function G(){f("close")}function L(){f("destroy")}function E(){f("hide")}function T(){f("isDestroyed")}function A(){f("isMinimized")}function D(){f("isShowing")}function X(){f("minimize")}function M(){f("open"),typeof o=="function"&&o(i.current)}function z(){f("show")}function S(){f("update")}let N={close:G,destroy:L,hide:E,isDestroyed:T,isMinimized:A,isShowing:D,minimize:X,open:M,show:z,update:S};function V(){var y;return(y=s.current)==null?void 0:y.createUploadWidget(P,(w,n)=>{if(typeof w=="string"&&p(w),typeof(n==null?void 0:n.event)=="string"){xe.includes(n==null?void 0:n.event)&&b(n);let h=_e[n.event];if(typeof h=="string"&&typeof m[h]=="function"&&typeof m[h]){let j=m[h];j(n,{widget:i.current,...N})}}})}return K.createElement(K.Fragment,null,typeof e=="function"&&e({cloudinary:s.current,widget:i.current,results:u,error:r,isLoading:U,...N}),K.createElement(we,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://widget.cloudinary.com/v2.0/global/all.js",onLoad:x,onError:y=>console.error(`Failed to load Cloudinary Upload Widget: ${y.message}`)}))},H=be;var ve=({className:e,children:l,onClick:a,onError:o,onOpen:t,onUpload:d,onAbort:g,onBatchCancelled:c,onClose:m,onDisplayChanged:s,onPublicId:i,onQueuesEnd:C,onQueuesStart:r,onRetry:p,onShowCompleted:u,onSourceChanged:b,onSuccess:U,onTags:W,onUploadAdded:P,options:x,signatureEndpoint:v,uploadPreset:f,...G})=>$.createElement($.Fragment,null,$.createElement(H,{onError:o,onOpen:t,onUpload:d,onAbort:g,onBatchCancelled:c,onClose:m,onDisplayChanged:s,onPublicId:i,onQueuesEnd:C,onQueuesStart:r,onRetry:p,onShowCompleted:u,onSourceChanged:b,onSuccess:U,onTags:W,onUploadAdded:P,options:x,signatureEndpoint:v,uploadPreset:f},({open:L,isLoading:E})=>{function T(A){A.preventDefault(),L(),typeof a=="function"&&a(A)}return $.createElement("button",{...G,className:e||"",onClick:T,disabled:E},l||"Upload")})),se=ve;import _,{useRef as B}from"react";import Le from"next/script";import Te from"next/head";import{parseUrl as Ae}from"@cloudinary-util/util";var Ne=e=>{let l=B(Math.ceil(Math.random()*1e5)),{autoPlay:a="never",className:o,colors:t,controls:d=!0,fontFace:g,height:c,id:m,logo:s=!0,loop:i=!1,muted:C=!1,onDataLoad:r,onError:p,onMetadataLoad:u,onPause:b,onPlay:U,onEnded:W,src:P,transformation:x,version:v="1.9.16",quality:f="auto",width:G}=e,L=Array.isArray(x)?x:[x],E=P;if(typeof e.version=="string"&&console.warn("The version prop will no longer be supported in future versions due to the unreliability of coordinating assets"),E.startsWith("http"))try{let n=Ae(P);typeof(n==null?void 0:n.publicId)=="string"&&(E=n==null?void 0:n.publicId)}catch(n){}L.unshift({quality:f});let T=B(),A=B(),D=e.videoRef||A,X=B(),M=e.playerRef||X,z=m||`player-${E.replace("/","-")}-${l.current}`,S="cld-video-player cld-fluid";o&&(S=`${S} ${o}`);let N={error:p,loadeddata:r,loadedmetadata:u,pause:b,play:U,ended:W};function V(n){let h=N[n.type];typeof h=="function"&&h(w())}function y(){if("cloudinary"in window){T.current=window.cloudinary;let n={};typeof s=="boolean"?n.showLogo=s:typeof s=="object"&&(n={...n,showLogo:!0,logoImageUrl:s.imageUrl,logoOnclickUrl:s.onClickUrl});let h={autoplayMode:a,cloud_name:process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,controls:d,fontFace:g||"",loop:i,muted:C,publicId:E,secure:!0,transformation:L,...n};typeof t=="object"&&(h.colors=t),M.current=T.current.videoPlayer(D.current,h),Object.keys(N).forEach(j=>{var J;typeof N[j]=="function"&&((J=M.current)==null||J.on(j,V))})}}function w(){return{player:M.current,video:D.current}}return _.createElement(_.Fragment,null,_.createElement(Te,null,_.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${v}/dist/cld-video-player.min.css`,rel:"stylesheet"})),_.createElement("div",{style:{width:"100%",aspectRatio:`${e.width} / ${e.height}`}},_.createElement("video",{ref:D,id:z,className:S,width:G,height:c}),_.createElement(Le,{id:`cloudinary-videoplayer-${Math.floor(Math.random()*100)}`,src:`https://unpkg.com/cloudinary-video-player@${v}/dist/cld-video-player.min.js`,onLoad:y,onError:n=>console.error(`Failed to load Cloudinary Video Player: ${n.message}`)})))},ce=Ne;function We(e){return I({...e,crop:e.crop||"fill",format:e.format||"jpg",gravity:e.gravity||"center",height:e.height||1254,width:e.width||2400,widthResize:e.width||1200})}export{ne as CldImage,ie as CldOgImage,se as CldUploadButton,H as CldUploadWidget,ce as CldVideoPlayer,F as cloudinaryLoader,I as getCldImageUrl,We as getCldOgImageUrl};
//# sourceMappingURL=index.mjs.map